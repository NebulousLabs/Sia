File Contract Negotiation
=========================

Securing data on Sia requires creating and revising file contracts in an
untrusted environment. Managing data on Sia happens through several protocols:

+ Settings Request - the host sends the renter its settings.

+ Revision Request - the renter will send the host a file contract id, and the
  host will send the most recent file contract revision that it knows of for
  that file contract, with the signatures.

+ File Contract Creation - no data is uploaded during the inital creation of a
  file contract, but funds are allocated so that the file contract can be
  iteratively revised in the future.

+ File Contract Revision - an existing file contract is revised so that data
  can be added to an arbitrary place, or removed from an arbitrary place.

+ File Contract Renewal - an existing file contract is renewed, meaning that a
  new file contract with a different id is created, but that has the same data.
  New funds are added to this file contract, and it can now be modified
  separately from the previous contract.

+ Data Request - data is requested from the host for retrieval.

+ (planned for later) Storage Proof Request - the renter requests that the host
  perform an out-of-band storage proof.

+ (planned for later) Metadata Request - the renter requests some metadata
  about the file contract from the host, namely the list of hashes that compose
  the file. This list of hashes is provided along with a cryptographic proof
  that the hashes are valid. The proof is only needed if only a subset of
  hashes are being sent.

A frequently seen construction is 'acceptance'. The renter or host may have the
opportunity to accept or reject a communication, which takes the form of a
string. The acceptance string is always the same, and any string that is not
the acceptance string is a rejection. The rejection string can include reasons
why the rejection occurred, but most not exceed 255 bytes. After a rejection,
the connection is always closed.

The protocols described below are numbered. The number indicates when the
communicator is switching. Each pair of numbers is a full round trip of
communications.

All communications attempt to support slow connections and Tor connections. Any
connection with a throughput below 100kbps may struggle to perform the uploads
and downloads, and any connection with a rountrip latency greater than 2
minutes may struggle to complete the protocols.

Settings Request
----------------

1. The renter makes an RPC to the host, opening a connection. The connection
   deadline should be at least 120 seconds.

2. The host sends the renter the most recent copy of its settings, signed by
   the host public key. The connection is then closed.

Revision Request
----------------

1. The renter makes an RPC to the host, opening a connection. The connection
   deadline sould be at least 120 seconds. The renter sends the file contract
   id for the revision being requested.

2. The host sends the renter the most recent file contract revision, along with
   the transaction signatures from both the renter and the host. The connection
   is then closed.

File Contract Creation
----------------------

A few decisions were made regarding the file contract protocol. The first is
that the renter should not sign the file contract until the host has formally
accepted the file contract. The second is that the host should be the last one
to sign the file contract, as the renter is the party with the strong
reputation system.

Instead of sending a whole transaction each time, the transaction is sent
piecemeal, and only the new parts at each step are sent to the other party.
This minimizes the surface area of data for a malicious party to manipulate,
which means less verification code, which means less chances of having a bug in
the verification code.

The renter pays for the siafund fee on the host's collateral and contract fee.
If a renter opens a file contract and then never uses it, the host does not
lose money. This does put the renter at risk, as they may open up a file
contract and then watch the host leave, but the renter is spreading the risk
over communications with many hosts, and has a reputation system that will help
ensure that the renter is only dealing with upstanding hosts.

1. The renter makes an RPC to the host, opening a connection. The connection
   deadline should be at least 360 seconds.

2. The host sends the renter the most recent copy of its settings, signed. If
   the host is not accepting new file contracts, the connection is closed.

3. The renter sends a notice of acceptance or rejection. If the renter accepts,
   the renter then sends a funded file contract without a signature, followed
   by the public key that will be used to create the renter's portion of the
   UnlockConditions for the file contract.

4. The host sends an acceptance or rejection of the file contract. If the host
   accepts, the host will add collateral to the file contract, and will send
   the renter the inputs + outputs for the collateral, followed by any new
   parent transactions. The length of any of these may be zero.

5. The renter indicates acceptance or rejection of the file contract. If the
   renter accepts, the renter will sign the file contract and send the
   transaction signatures to the host.

6. The host may only reject the file contract in the event that the renter has
   sent invalid signatures, so the acceptance step is skipped. The host signs
   the file contract and sends the transaction signatures to the renter. The
   connection is closed.

File Contract Revision
----------------------

1. The renter makes an RPC to the host, opening a connection. The minimum
   deadline for the connection is 600 seconds. The renter then sends a file
   contract ID, indicting the file contract that is getting revised during the
   RPC.

2. The host will send an acceptance or rejection. A loop begins. The host sends
   the most recent revision of the host settings to the renter, and a copy of
   the most recent known revision transaction set. The transaction will be empty if
   there have been no completed revisions yet. The host is expected to always
   have the most recent revision, the renter may not have the most recent
   revision. The settings are sent after each iteration of the loop to enable
   high resolution dynamic pricing for the host, especially for bandwidth.

3. The renter may reject or accept the settings + revision. The renter will
   send a batch of modification actions. Batching allows the renter to send a
   lot of data in a single, one-way connection, improving throughput. The
   renter will send a number indicating how many modifications will be made in
   a batch, and then sends each modification in order.

   A single modification can either be an insert, a modify, or a delete. An
   insert is an index, indicating the index where the data is going to be
   inserted. '0' indicates that the data is inserted at the very beginning, '1'
   indicates that the data will be inserted between the first and second
   existing sectors, etc. The index is followed by the 4MB of data. A modify is
   an index indicating which sector is being modified, followed by an offset
   indicating which data within the sector is being modified. Finally, some
   data is provided indicating what the data in the sector should be replaced
   with starting from that offset. The offset + len of the data should not
   exceed the sector size of 4MB. A delete is an index indicating the index of
   the sector that is being deleted. Each operation within a batch is atomic,
   meaning if you are inserting 3 sectors at the front of the file contract,
   the indexes of each should be '0', '1', '2'.

   The renter sends a file contract revision which pays the host for all of the
   modifications and bandwidth consumed. The revision is not signed.

4. The host indicates either acceptance or rejection of the new revision.

5. The renter signs the revision and sends the signature to the host. The
   renter will then send an indication of whether another iteration of the loop
   is desired.

6. The host signs the revision and sends the siganture to the renter. Both
   parties submit the new revision to the transaction pool. The host sends an
   acceptance or rejection indicating whether another iteration is okay. If
   another iteration is to be performed, the connection deadline will be reset
   so that there are at least 600 seconds remaining.

File Contract Renewal
---------------------

1. The renter makes an RPC to the host, opening a connection. The minimum
   deadline for the connection is 600 seconds. The host needs extra time
   because a significant amount of metadata modifications may be necessary on
   the host's end, especially when renewing larger file contracts.

2. The host sends the most recent copy of the settings to the renter, along
   with the most recent file contract revision. If the host is not accepting
   new file contracts, the connection is closed.

3. The renter either accepts or rejects the settings. If accepted, the renter
   sends an unsigned file contract to the host, containing the same Merkle root
   as the previous file contract, and also containing a renewed payout with
   conditional payments to the host to cover the host storing the data for the
   extended duration.

4. The host will accept or reject the renewed file contract. If accepted, the
   host will add collateral (and miner fees if desired) and return the file
   contract unsigned to the renter.

5. The renter will accept or reject the host's additions. If accepting, the
   renter will sign the file contract and return it to the host.

6. The host will accept or reject the renter's signature on the file contract.
   If accepting, the host will add its signature and return the complete, fully
   signed file contract to the renter. The renter and the host may each now
   submit the file contract to their transaction pools.

Data Request
------------

1. The renter makes an RPC to the host, opening a connection. The connection
   deadline is at least 600 seconds.

2. The host will send the renter the most recent file contract revision
   transaction set.

   A loop begins, which will allow the renter to download multiple batches of
   data from the same connection. The host will send the host settings, and the
   most recent file contract revision transaction. If there is no revision yet,
   the host will send a blank transaction. The host is expected to always have
   the most recent revision (the host signs last), the renter may not have the
   most recent revision.

3. The renter will accept or reject the host's settings. If accepting, the
   renter will send a batch of download requests, which takes the form of a
   batch size followed by each of the requests in order. This request is
   followed by a file contract revision, which pays the host for the download
   bandwidth that is about to be consumed. The revision will be signed. The
   renter will also send a variable indicating whether another iteration is
   desired.

   A download request can either be a full sector or a partial sector. A full
   sector request will be followed by the hash of the sector. A partial sector
   request will be followed by the hash of the sector that is being partially
   downloaded, along with an offset and a length indicating which portion of
   the sector is being downloaded.

4. The host will either accept or reject the revision. If accepted, the host
   will upload all of the data. The host will indicate whether another
   iteration is okay. If another iteration is acceptable, the deadline will be
   reset to a minimum of 600 seconds. The host is expected to accept at least
   1200 seconds of iterations.
